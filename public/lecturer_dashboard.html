<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lecturer Dashboard - UPath</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css">
    <style>
        .current-class-card {
            background: linear-gradient(135deg, var(--primary) 0%, #818CF8 100%);
            color: white;
            border-radius: var(--radius-lg);
            padding: 32px;
            margin-bottom: 28px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 24px;
        }
        .current-class-info h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .class-details {
            display: flex;
            gap: 20px;
            margin-top: 12px;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .start-btn {
            padding: 16px 32px;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: var(--radius);
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all var(--transition);
            text-decoration: none;
            white-space: nowrap;
        }
        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .no-class-card {
            background: var(--surface);
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 48px;
            text-align: center;
            margin-bottom: 28px;
        }
        .no-class-card h3 {
            color: var(--text);
            margin-bottom: 8px;
            font-size: 1.1rem;
        }
        .no-class-card p {
            color: var(--text-muted);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px 24px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .section-link {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--primary);
            text-decoration: none;
        }
        .section-link:hover { text-decoration: underline; }

        .classes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        .class-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px;
            transition: all var(--transition);
        }
        .class-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }
        .class-header {
            display: flex;
            align-items: start;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .class-code {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--primary);
            background: var(--primary-light);
            padding: 4px 10px;
            border-radius: 4px;
        }
        .class-name {
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }
        .class-info {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        .class-actions {
            display: flex;
            gap: 8px;
        }
        .class-actions .btn {
            flex: 1;
            padding: 10px 16px;
            font-size: 0.85rem;
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
        }
        .quick-action {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            text-decoration: none;
            color: var(--text);
            transition: all var(--transition);
        }
        .quick-action:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }
        .quick-action-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-light);
            color: var(--primary);
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
        }
        .quick-action-text {
            font-weight: 600;
            font-size: 0.9rem;
        }

        @media (max-width: 1024px) {
            .stats-row { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 768px) {
            .stats-row { grid-template-columns: 1fr; }
            .current-class-card { flex-direction: column; text-align: center; }
            .classes-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <a href="/lecturer_dashboard.html" class="navbar-brand">
            <div class="navbar-logo">U</div>
            <span class="navbar-title">UPath</span>
            <span class="navbar-role" style="background: #FEE2E2; color: #DC2626;">Staff</span>
        </a>
        <div class="navbar-nav">
            <a href="/lecturer_dashboard.html" class="navbar-link active">Overview</a>
            <a href="/pages/lecturer/my_classes.html" class="navbar-link">Classes</a>
            <a href="/pages/lecturer/lecturer_schedule.html" class="navbar-link">Schedule</a>
            <a href="/pages/lecturer/lecturer_reports.html" class="navbar-link">Analytics</a>
        </div>
        <div class="navbar-actions">
            <a href="/pages/lecturer/profile.html" class="navbar-avatar" id="userAvatar" style="text-decoration: none;">LC</a>
            <button class="navbar-logout" onclick="logout()">Sign Out</button>
        </div>
    </nav>

    <main class="page">
        <div class="page-container">
            <!-- Header with Live Clock -->
            <div class="page-header" style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div>
                    <h1 class="page-title" id="welcomeTitle">Welcome back</h1>
                    <p class="page-subtitle" id="dateDisplay"></p>
                </div>
                <div style="text-align: right;">
                    <div id="liveClock" style="font-size: 2rem; font-weight: 800; color: #DC2626;"></div>
                    <div style="font-size: 0.8rem; color: var(--text-muted);">Current Time</div>
                </div>
            </div>

            <!-- Current/Next Class Card -->
            <div id="currentClassContainer"></div>

            <!-- Stats -->
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-value" id="totalClasses">0</div>
                    <div class="stat-label">Total Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="todayClasses">0</div>
                    <div class="stat-label">Today's Classes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalStudentsVal">156</div>
                    <div class="stat-label">Total Students</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgAttendanceVal">88%</div>
                    <div class="stat-label">Avg Attendance</div>
                </div>
            </div>

            <!-- My Classes -->
            <div class="section-title">
                My Classes
                <a href="/pages/lecturer/my_classes.html" class="section-link">View All</a>
            </div>
            <div class="classes-grid" id="classesGrid">
                <!-- Dynamically loaded -->
            </div>

            <!-- Quick Actions -->
            <div class="section-title">Quick Actions</div>
            <div class="quick-actions">
                <a href="/pages/lecturer/qr_code.html" class="quick-action">
                    <div class="quick-action-icon">QR</div>
                    <div class="quick-action-text">Generate QR</div>
                </a>
                <a href="/pages/lecturer/manual_attendance.html" class="quick-action">
                    <div class="quick-action-icon">MA</div>
                    <div class="quick-action-text">Manual Entry</div>
                </a>
                <a href="/pages/lecturer/lecturer_schedule.html" class="quick-action">
                    <div class="quick-action-icon">SC</div>
                    <div class="quick-action-text">Schedule</div>
                </a>
                <a href="/pages/lecturer/lecturer_reports.html" class="quick-action">
                    <div class="quick-action-icon">AN</div>
                    <div class="quick-action-text">Analytics</div>
                </a>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script>
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        let lecturerId = '210101';

        function loadUserData() {
            const userStr = sessionStorage.getItem('upath_user');
            if (userStr) {
                const user = JSON.parse(userStr);
                const displayName = user.fullName || 'Lecturer';
                document.getElementById('welcomeTitle').textContent = `Welcome back, ${displayName}`;
                
                if (user.id) lecturerId = user.id;
                
                if (user.fullName) {
                    const initials = user.fullName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                    document.getElementById('userAvatar').textContent = initials;
                }
            }
        }

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-US', options);
        }

        async function loadClasses() {
            const now = new Date();
            const today = dayNames[now.getDay()];
            const currentHour = now.getHours();
            
            // Get timetable
            const allClasses = await API.fetchTimetable();
            const myClasses = allClasses.filter(c => c.lecturerId === lecturerId);
            const todayClasses = myClasses.filter(c => c.day === today);
            
            // --- NEW: FETCH STATS FROM SERVER FOR CONSISTENCY ---
            const uniqueCodes = [...new Set(myClasses.map(c => c.code))];
            let totalAvg = 0;
            let totalSessions = 0;
            
            try {
                // Fetch stats for all courses in parallel
                const statsPromises = uniqueCodes.map(code => API.fetchCourseStats(code));
                const results = await Promise.all(statsPromises);
                
                // Calculate weighted global average
                let weightedSum = 0;
                let validCourses = 0;
                
                results.forEach(stat => {
                    if (stat.totalSessions > 0) {
                        weightedSum += stat.avgAttendance; 
                        validCourses++;
                        totalSessions += stat.totalSessions;
                    }
                });
                
                if (validCourses > 0) {
                    totalAvg = Math.round(weightedSum / validCourses);
                }
                
                // Approximate total students (mock) or sum up if we had enrollment data
                // For now, simple mock sum based on course count to match reports
                document.getElementById('totalStudentsVal').textContent = uniqueCodes.length * 40; 
                document.getElementById('avgAttendanceVal').textContent = totalAvg + '%';
                
            } catch (err) {
                console.error("Dashboard stats sync failed:", err);
            }
            // ----------------------------------------------------
            
            // Update class counts
            document.getElementById('totalClasses').textContent = uniqueCodes.length;
            document.getElementById('todayClasses').textContent = todayClasses.length;
            
            // Find current or next class
            const container = document.getElementById('currentClassContainer');
            const currentClass = todayClasses.find(c => {
                const startHour = parseInt(c.time.split(':')[0]);
                return currentHour >= startHour && currentHour < startHour + 2;
            });
            
            const nextClass = todayClasses.find(c => {
                const startHour = parseInt(c.time.split(':')[0]);
                return startHour > currentHour;
            });
            
            if (currentClass) {
                container.innerHTML = `
                    <div class="current-class-card">
                        <div class="current-class-info">
                            <h3>Currently Teaching: ${currentClass.name}</h3>
                            <p>${currentClass.code} • ${currentClass.room}</p>
                            <div class="class-details">
                                <span>${currentClass.time}</span>
                                <span>Year ${currentClass.year} Students</span>
                            </div>
                        </div>
                        <a href="/pages/lecturer/qr_code.html?class=${currentClass.code}" class="start-btn">Generate QR Code</a>
                    </div>
                `;
            } else if (nextClass) {
                const startHour = parseInt(nextClass.time.split(':')[0]);
                const minsUntil = (startHour - currentHour) * 60 - now.getMinutes();
                container.innerHTML = `
                    <div class="current-class-card" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%);">
                        <div class="current-class-info">
                            <h3>Next Class: ${nextClass.name}</h3>
                            <p>${nextClass.code} • ${nextClass.room} • Starting in ~${minsUntil} min</p>
                            <div class="class-details">
                                <span>${nextClass.time}</span>
                                <span>Year ${nextClass.year} Students</span>
                            </div>
                        </div>
                        <a href="/pages/lecturer/qr_code.html?class=${nextClass.code}" class="start-btn">Prepare QR Code</a>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="no-class-card">
                        <h3>No More Classes Today</h3>
                        <p>Enjoy your free time. Your next class is on ${getNextClassDay(myClasses)}.</p>
                    </div>
                `;
            }
            
            // Render unique classes
            const classesGrid = document.getElementById('classesGrid');
            
            let html = '';
            uniqueCodes.forEach(code => {
                const c = myClasses.find(cl => cl.code === code);
                const sessions = myClasses.filter(cl => cl.code === code);
                
                html += `
                    <div class="class-card">
                        <div class="class-header">
                            <span class="class-code">${c.code}</span>
                            <span style="font-size: 0.75rem; color: var(--text-muted);">Year ${c.year}</span>
                        </div>
                        <div class="class-name">${c.name}</div>
                        <div class="class-info">${sessions.length} sessions/week • ${c.room}</div>
                        <div class="class-actions">
                            <a href="/pages/lecturer/qr_code.html?class=${c.code}" class="btn btn-primary">QR Code</a>
                            <a href="/pages/lecturer/manual_attendance.html?class=${c.code}" class="btn btn-secondary">Manual</a>
                        </div>
                    </div>
                `;
            });
            
            classesGrid.innerHTML = html || '<div class="text-muted">No classes assigned</div>';
        }

        function getNextClassDay(classes) {
            const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const todayIdx = new Date().getDay();
            
            for (let i = 1; i <= 7; i++) {
                const checkDay = dayNames[(todayIdx + i) % 7];
                if (classes.some(c => c.day === checkDay)) {
                    return checkDay;
                }
            }
            return 'your next scheduled day';
        }

        function logout() {
            sessionStorage.removeItem('upath_user');
            window.location.href = '/pages/auth.html';
        }

        /**
         * Update the live clock display every second
         */
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true 
            });
            document.getElementById('liveClock').textContent = timeStr;
        }

        // Initialize on page load
        loadUserData();
        updateDate();
        loadClasses();
        updateClock();
        
        // Update clock every second
        setInterval(updateClock, 1000);
    </script>
</body>
</html>
