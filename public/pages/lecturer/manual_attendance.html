<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Attendance - UPath</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../../css/theme.css">
</head>
<body>
    <nav class="navbar">
        <a href="../../lecturer_dashboard.html" class="navbar-brand">
            <div class="navbar-logo">U</div>
            <span class="navbar-title">UPath</span>
            <span class="navbar-role" style="background: #FEE2E2; color: #DC2626;">Staff</span>
        </a>
        <div class="navbar-nav">
            <a href="../../lecturer_dashboard.html" class="navbar-link">Overview</a>
            <a href="../../pages/lecturer/my_classes.html" class="navbar-link">Classes</a>
            <a href="../../pages/lecturer/lecturer_schedule.html" class="navbar-link">Schedule</a>
            <a href="../../pages/lecturer/lecturer_reports.html" class="navbar-link">Analytics</a>
        </div>
        <div class="navbar-actions">
            <div class="navbar-avatar">LC</div>
            <button class="navbar-logout" onclick="logout()">Sign Out</button>
        </div>
    </nav>

    <main class="page">
        <div class="page-container" style="max-width: 800px;">
            <div class="page-header flex justify-between items-center">
                <div>
                    <h1 class="page-title">Manual Attendance</h1>
                    <p class="page-subtitle">Mark attendance for your class</p>
                </div>
                <select class="select" style="width: auto;" onchange="loadStudents(this.value)">
                    <option value="" disabled selected>Loading classes...</option>
                </select>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Student List</h3>
                    <div class="flex gap-1">
                        <button class="btn btn-secondary btn-sm" onclick="selectAll()">Select All</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearAll()">Clear All</button>
                        <button class="btn btn-primary btn-sm" onclick="addStudentPrompt()">+ Add Student</button>
                    </div>
                </div>

                <div id="studentList">
                    <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                        Select a class above to load students.
                    </div>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary" onclick="saveAttendance()" style="width: 100%;">
                        Save Attendance
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="../../js/api.js"></script>
    <script>
        let currentClass = null;
        let classList = [];

        async function initPage() {
            const user = API.getCurrentUser();
            if (!user || user.role !== 'lecturer') {
                window.location.href = '../../pages/auth.html';
                return;
            }

            // Load Lecturer's Classes using API
            const classes = await API.getClassesByLecturer(user.id);
            classList = classes;
            
            // DEDUP: Group classes by course code (show each course only once)
            const uniqueCourses = [];
            const seenCodes = new Set();
            classes.forEach(c => {
                if (!seenCodes.has(c.code)) {
                    seenCodes.add(c.code);
                    uniqueCourses.push(c);
                }
            });
            
            const select = document.querySelector('.select');
            if (uniqueCourses.length > 0) {
                select.innerHTML = uniqueCourses.map(c => 
                    `<option value="${c.code}">${c.code} - ${c.name}</option>`
                ).join('');
                
                // Auto-load first class
                loadStudents(uniqueCourses[0].code);
            } else {
                select.innerHTML = `<option disabled selected>No classes assigned</option>`;
            }
        }

        async function loadStudents(classCode) {
            currentClass = classList.find(c => c.code === classCode);
            if (!currentClass) return;

            const container = document.getElementById('studentList');
            container.innerHTML = `<div style="padding:20px; text-align:center;">Loading students with attendance data...</div>`;

            try {
                // Use new API endpoint that returns students with attendance stats
                const response = await fetch(`/api/attendance/students/${classCode}`);
                
                if (!response.ok) {
                    throw new Error('API error');
                }
                
                const data = await response.json();
                const students = data.students || [];
                
                if (students.length === 0) {
                    container.innerHTML = `
                        <div style="padding: 20px; text-align: center; color: var(--text-muted);">
                            No registered students found for this class.<br>
                            <small>Course: ${classCode}</small>
                        </div>`;
                    return;
                }
                
                // Sort: Danger first, then Risk, then Warning, then Good
                const order = { danger: 0, risk: 1, warning: 2, good: 3 };
                students.sort((a, b) => order[a.status] - order[b.status]);

                // Render List with REAL risk badges
                container.innerHTML = students.map(s => {
                    let badge = '';
                    if (s.status === 'danger') {
                        badge = `<span style="font-size:0.6rem; background:#fecaca; color:#dc2626; padding:2px 6px; border-radius:4px; margin-left:8px;">Danger (0%)</span>`;
                    } else if (s.status === 'risk') {
                        badge = `<span style="font-size:0.6rem; background:#fee2e2; color:#ef4444; padding:2px 6px; border-radius:4px; margin-left:8px;">At Risk (${s.percentage}%)</span>`;
                    } else if (s.status === 'warning') {
                        badge = `<span style="font-size:0.6rem; background:#fef3c7; color:#d97706; padding:2px 6px; border-radius:4px; margin-left:8px;">Warning (${s.percentage}%)</span>`;
                    } else {
                        badge = `<span style="font-size:0.6rem; background:#d1fae5; color:#059669; padding:2px 6px; border-radius:4px; margin-left:8px;">${s.percentage}%</span>`;
                    }
                    
                    return `
                    <div class="list-item" style="cursor: pointer; display:flex; align-items:center;">
                        <input type="checkbox" value="${s.id}" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div class="list-item-content" style="flex:1; margin-left:12px;">
                            <div class="list-item-title">${s.fullName} ${badge}</div>
                            <div class="list-item-subtitle">${s.id} â€¢ ${s.attended}/${s.total} sessions</div>
                        </div>
                        <button class="btn btn-sm btn-secondary" onclick="alert('Student ID: ${s.id}\\nProgram: ${s.program}\\nYear: ${s.year}\\nAttendance: ${s.attended}/${s.total} (${s.percentage}%)')" style="font-size:0.7rem; padding:4px 8px;">Details</button>
                    </div>
                `}).join('');

            } catch (e) {
                console.error(e);
                container.innerHTML = `<div style="color:red; text-align:center;">Error loading students.</div>`;
            }
        }

        function addStudentPrompt() {
            const id = prompt("Enter Student ID to add:");
            if (id) {
                alert(`Student ${id} added to class roster (Simulation).`);
                // In real app, we'd call API.enrollStudent(id, currentClass.code)
            }
        }

        function selectAll() {
            document.querySelectorAll('#studentList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function clearAll() {
            document.querySelectorAll('#studentList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        async function saveAttendance() {
            if (!currentClass) return;
            
            const inputs = document.querySelectorAll('#studentList input[type="checkbox"]:checked');
            const studentIds = Array.from(inputs).map(cb => cb.value);
            
            if (studentIds.length === 0) {
                alert('Please select at least one student.');
                return;
            }

            const btn = document.querySelector('.btn-primary');
            const originalText = btn.textContent;
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                // Use Bulk Mark Endpoint
                await API.saveBulkAttendance(currentClass.code, studentIds);
                
                // Visual Feedback
                alert(`Attendance saved for ${studentIds.length} student(s)!`);
                clearAll(); // Reset selection
            } catch (error) {
                console.error(error);
                alert('Failed to save attendance.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function logout() { sessionStorage.removeItem('upath_user'); window.location.href = '../../pages/auth.html'; }

        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
