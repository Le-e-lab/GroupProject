<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Attendance - UPath</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/theme.css">
</head>
<body>
    <nav class="navbar">
        <a href="/lecturer_dashboard.html" class="navbar-brand">
            <div class="navbar-logo">U</div>
            <span class="navbar-title">UPath</span>
            <span class="navbar-role" style="background: #FEE2E2; color: #DC2626;">Staff</span>
        </a>
        <div class="navbar-nav">
            <a href="/lecturer_dashboard.html" class="navbar-link">Overview</a>
            <a href="/pages/lecturer/my_classes.html" class="navbar-link">Classes</a>
            <a href="/pages/lecturer/lecturer_schedule.html" class="navbar-link">Schedule</a>
            <a href="/pages/lecturer/lecturer_reports.html" class="navbar-link">Analytics</a>
        </div>
        <div class="navbar-actions">
            <div class="navbar-avatar">LC</div>
            <button class="navbar-logout" onclick="logout()">Sign Out</button>
        </div>
    </nav>

    <main class="page">
        <div class="page-container" style="max-width: 800px;">
            <div class="page-header flex justify-between items-center">
                <div>
                    <h1 class="page-title">Manual Attendance</h1>
                    <p class="page-subtitle">Mark attendance for your class</p>
                </div>
                <select class="select" style="width: auto;" onchange="loadStudents(this.value)">
                    <option value="CS101">CS101 - Intro to Programming</option>
                    <option value="CS204">CS204 - Database Systems</option>
                    <option value="CS305">CS305 - Web Development</option>
                </select>
            </div>

            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Student List</h3>
                    <div class="flex gap-1">
                        <button class="btn btn-secondary btn-sm" onclick="selectAll()">Select All</button>
                        <button class="btn btn-secondary btn-sm" onclick="clearAll()">Clear All</button>
                    </div>
                </div>

                <div id="studentList">
                    <label class="list-item" style="cursor: pointer;">
                        <input type="checkbox" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div class="list-item-content">
                            <div class="list-item-title">Alice Johnson</div>
                            <div class="list-item-subtitle">240001</div>
                        </div>
                    </label>
                    <label class="list-item" style="cursor: pointer;">
                        <input type="checkbox" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div class="list-item-content">
                            <div class="list-item-title">Bob Smith</div>
                            <div class="list-item-subtitle">240002</div>
                        </div>
                    </label>
                    <label class="list-item" style="cursor: pointer;">
                        <input type="checkbox" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div class="list-item-content">
                            <div class="list-item-title">Carol Williams</div>
                            <div class="list-item-subtitle">240003</div>
                        </div>
                    </label>
                    <label class="list-item" style="cursor: pointer;">
                        <input type="checkbox" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div class="list-item-content">
                            <div class="list-item-title">David Brown</div>
                            <div class="list-item-subtitle">240004</div>
                        </div>
                    </label>
                    <label class="list-item" style="cursor: pointer;">
                        <input type="checkbox" style="width: 20px; height: 20px; accent-color: var(--primary);">
                        <div class="list-item-content">
                            <div class="list-item-title">Eve Davis</div>
                            <div class="list-item-subtitle">240005</div>
                        </div>
                    </label>
                </div>

                <div class="mt-3">
                    <button class="btn btn-primary" onclick="saveAttendance()" style="width: 100%;">
                        Save Attendance
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/api.js"></script>
    <script>
        let currentClass = null;
        let classList = [];

        async function initPage() {
            const user = API.getCurrentUser();
            if (!user || user.role !== 'lecturer') {
                window.location.href = '/pages/auth.html';
                return;
            }

            // Load Lecturer's Classes
            const classes = API.getClassesByLecturer(user.id);
            classList = classes;
            
            const select = document.querySelector('.select');
            select.innerHTML = classes.map(c => 
                `<option value="${c.code}">${c.code} - ${c.name} (${c.time})</option>`
            ).join('');
            
            // Allow "All Classes" or default to first
            if (classes.length > 0) {
                loadStudents(classes[0].code);
            }
        }

        function loadStudents(classCode) {
            currentClass = classList.find(c => c.code === classCode);
            if (!currentClass) return;

            // Get students for this class year
            const students = API.getStudentsForClass(currentClass.year);
            const container = document.getElementById('studentList');
            
            container.innerHTML = students.map(s => `
                <label class="list-item" style="cursor: pointer;">
                    <input type="checkbox" value="${s.id}" style="width: 20px; height: 20px; accent-color: var(--primary);">
                    <div class="list-item-content">
                        <div class="list-item-title">${s.fullName}</div>
                        <div class="list-item-subtitle">${s.id}</div>
                    </div>
                </label>
            `).join('');
        }

        function selectAll() {
            document.querySelectorAll('#studentList input[type="checkbox"]').forEach(cb => cb.checked = true);
        }

        function clearAll() {
            document.querySelectorAll('#studentList input[type="checkbox"]').forEach(cb => cb.checked = false);
        }

        async function saveAttendance() {
            if (!currentClass) return;
            
            const inputs = document.querySelectorAll('#studentList input[type="checkbox"]:checked');
            const studentIds = Array.from(inputs).map(cb => cb.value);
            
            if (studentIds.length === 0) {
                alert('Please select at least one student.');
                return;
            }

            const btn = document.querySelector('.btn-primary');
            const originalText = btn.textContent;
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                // Determine Mode: Loop vs Bulk (API supports bulk-mark? checked api.js, yes, saveBulkAttendance exists)
                // Let's use bulk for efficiency if intended, but user prompt "syncing with actual data" implies thoroughness.
                // API.saveBulkAttendance exists in api.js line 721. Using that.
                
                await API.saveBulkAttendance(currentClass.code, studentIds);
                
                // Also update individual stats for immediate feedback transparency? 
                // The bulk endpoint doesn't really "persist" deeply in this mock setup (it logs console). 
                // To ensure "Overview" sees it, we might need to rely on the local storage logic in API.
                // `saveBulkAttendance` in api.js (line 721) does a fetch. Backend handles it.
                // But fallback just logs.
                // To be safe for THIS demo without full backend, let's also manually mark local storage if needed?
                // Actually `markAttendanceAsync` (line 1028) has fallback `markAttendance`. 
                // `saveBulkAttendance` (line 721) DOES NOT have a functional fallback that writes to storage! It just logs.
                 
                // CRITICAL FIX: Loop markAttendanceAsync instead, because it has robust fallback to local storage
                // which updates the dashboard numbers immediately even without backend.
                
                const promises = studentIds.map(sid => API.markAttendanceAsync(sid, currentClass.code));
                await Promise.all(promises);

                alert(`Attendance saved for ${studentIds.length} student(s)!`);
            } catch (error) {
                console.error(error);
                alert('Failed to save attendance.');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function logout() { sessionStorage.removeItem('upath_user'); window.location.href = '/pages/auth.html'; }

        // Init
        document.addEventListener('DOMContentLoaded', initPage);
    </script>
</body>
</html>
